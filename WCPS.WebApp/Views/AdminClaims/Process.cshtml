@model WCPS.WebApp.ViewModels.AdminProcessViewModel

@{
    ViewData["Title"] = "Process Claim";
}

<div class="container mt-4">
    <h2 class="mb-4">Process Claim</h2>

    @* Claim Summary + Preview / Download *@
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h4 class="card-title">@Model.Title</h4>
                    <p class="text-muted mb-1">Ref: <code>@Model.ClaimRef</code></p>
                    <p><strong>Employee:</strong> @Model.EmployeeName</p>
                    <p><strong>Amount Claimed:</strong> ₹@Model.AmountClaimed.ToString("N2")</p>
                </div>
                <div class="text-end">
                    @* Compute the preview/download URLs here from the claim id (no model change required) *@
                    @{
                        var previewUrl = Url.Action("DownloadReceipt", "Claims", new { id = Model.ClaimId, mode = "preview" });
                        var downloadUrl = Url.Action("DownloadReceipt", "Claims", new { id = Model.ClaimId, mode = "download" });
                    }
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary me-1" id="previewBtn" data-preview-url="@previewUrl"
                                @(string.IsNullOrEmpty(previewUrl) ? "disabled" : "")>
                            Preview
                        </button>

                        <button type="button" class="btn btn-sm btn-outline-secondary" id="downloadBtn" data-download-url="@downloadUrl"
                                @(string.IsNullOrEmpty(downloadUrl) ? "disabled" : "")>
                            Download
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Approve / Reject Form *@
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-bold">
            Action
        </div>
        <div class="card-body">
            <form asp-action="Process" method="post">
                <input type="hidden" asp-for="ClaimId" />

                <div class="mb-3">
                    <label class="form-label">Choose Action</label>
                    <select asp-for="Action" class="form-select" aria-label="Choose action" id="actionSelect">
                        <option value="">-- Select --</option>
                        <option value="approve">Approve</option>
                        <option value="reject">Reject</option>
                    </select>
                </div>

                <div class="mb-3" id="approvedAmountGroup" style="display:none;">
                    <label asp-for="AmountApproved" class="form-label">Approved Amount</label>
                    <input asp-for="AmountApproved" class="form-control" />
                    <span asp-validation-for="AmountApproved" class="text-danger"></span>
                    <div class="form-text">Enter full or partial approved amount.</div>
                </div>

                <button type="submit" class="btn btn-primary">Submit</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
            </form>
        </div>
    </div>

    @* Audit Trail *@
    <div class="card shadow-sm">
        <div class="card-header bg-light fw-bold">
            Audit Trail
        </div>
        <div class="card-body p-0">
            @if (Model.AuditEntries != null && Model.AuditEntries.Any())
            {
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Action</th>
                            <th>By</th>
                            <th>When</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var entry in Model.AuditEntries)
                        {
                            <tr>
                                <td>@entry.Action</td>
                                <td>@entry.PerformedByName</td>
                                <td>@entry.Timestamp.ToLocalTime().ToString("dd MMM yyyy, HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <div class="p-3 text-muted">No audit entries yet.</div>
            }
        </div>
    </div>
</div>

@* Preview modal (single) *@
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:1100px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Receipt Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" style="height:80vh;">
                <iframe id="previewFrame" src="" width="100%" height="100%" frameborder="0"></iframe>
            </div>
        </div>
    </div>
</div>

@* Download confirm modal (single) *@
<div class="modal fade" id="confirmDownloadModal" tabindex="-1" aria-labelledby="confirmDownloadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDownloadModalLabel">Confirm Download</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to download this receipt? It will be saved to your device.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a id="confirmDownloadBtn" class="btn btn-sm btn-primary" href="#" role="button">Confirm Download</a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const actionSelect = document.getElementById("actionSelect");
            const approvedGroup = document.getElementById("approvedAmountGroup");

            function toggleApproved() {
                if (actionSelect && actionSelect.value === "approve") {
                    approvedGroup.style.display = "block";
                } else if (approvedGroup) {
                    approvedGroup.style.display = "none";
                }
            }
            if (actionSelect) {
                actionSelect.addEventListener("change", toggleApproved);
                toggleApproved();
            }

            // preview button behavior (single preview button on the page)
            var previewBtn = document.getElementById("previewBtn");
            if (previewBtn) {
                previewBtn.addEventListener("click", function () {
                    var url = this.getAttribute('data-preview-url');
                    var frame = document.getElementById('previewFrame');
                    frame.setAttribute('src', url);
                    var modalEl = document.getElementById('previewModal');
                    var modal = new bootstrap.Modal(modalEl);
                    modal.show();
                });

                var previewModalEl = document.getElementById('previewModal');
                previewModalEl.addEventListener('hidden.bs.modal', function () {
                    document.getElementById('previewFrame').setAttribute('src', '');
                });
            }

            // download button -> show confirmation modal
            var downloadBtn = document.getElementById("downloadBtn");
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function () {
                    var url = this.getAttribute('data-download-url');
                    document.getElementById('confirmDownloadBtn').setAttribute('href', url);
                    var confirmModalEl = document.getElementById('confirmDownloadModal');
                    var confirmModal = new bootstrap.Modal(confirmModalEl);
                    confirmModal.show();
                });
            }
        })();
    </script>
}
