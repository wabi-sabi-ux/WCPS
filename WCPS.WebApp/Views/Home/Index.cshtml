@model WCPS.WebApp.ViewModels.DashboardViewModel
@using WCPS.WebApp.Models

@{
    ViewData["Title"] = "Home";
    bool isAuthenticated = User.Identity?.IsAuthenticated == true;
    bool isAdmin = isAuthenticated && User.IsInRole("CpdAdmin");
}

@if (!isAuthenticated)
{
    <!-- PUBLIC LANDING -->
    <div class="container mt-5">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1 class="display-4">Welcome to WCPS</h1>
                <p class="lead text-muted">A simple web-based claims processing system — submit receipts, track claims, and get approvals faster.</p>

                <ul class="list-unstyled">
                    <li>• Submit expense claims with receipts</li>
                    <li>• Admin workflows for approval or rejection</li>
                    <li>• Transparent audit trail for accountability</li>
                </ul>

                <p class="mt-4">
                    <a class="btn btn-primary btn-lg me-2" asp-area="Identity" asp-page="/Account/Login">Login</a>
                    <a class="btn btn-outline-secondary btn-lg" asp-area="Identity" asp-page="/Account/Register">Register</a>
                </p>
            </div>
        </div>
    </div>
}
else if (isAdmin)
{
    <!-- ADMIN DASHBOARD -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Admin Dashboard</h1>
            <div>
                <a class="btn btn-outline-primary" asp-controller="AdminClaims" asp-action="Index">View Pending</a>
                <a class="btn btn-outline-secondary ms-2" asp-controller="AdminClaims" asp-action="Audit">Open Audit</a>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Pending</h6>
                        <p class="display-6">@Model.PendingClaimsCount</p>
                        <p class="text-muted small mb-0">Claims awaiting approval</p>
                    </div>
                    <div class="card-footer bg-white">
                        <a asp-controller="AdminClaims" asp-action="Index" class="btn btn-sm btn-primary">Process</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Employees</h6>
                        <p class="display-6">@Model.TotalEmployees</p>
                        <p class="text-muted small mb-0">Active accounts</p>
                    </div>
                    <div class="card-footer bg-white">
                        <a asp-controller="AdminEmployees" asp-action="Index" class="btn btn-sm btn-outline-secondary">Manage</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <h6 class="card-title">Recent Activity</h6>
                        <p class="mb-0 small text-muted">@Model.RecentActivity.Count item(s)</p>
                    </div>
                    <div class="card-footer bg-white">
                        <a asp-controller="AdminClaims" asp-action="Audit" class="btn btn-sm btn-outline-primary">Open Audit</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">Claims Overview</div>
                    <div class="card-body">
                        <canvas id="claimsPieChart" style="height:250px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header">Recent Activity (audit)</div>
                    <div class="card-body p-0">
                        @if (Model.RecentActivity == null || !Model.RecentActivity.Any())
                        {
                            <div class="p-3 text-muted">No recent activity.</div>
                        }
                        else
                        {
                            <table class="table table-sm mb-0">
                                <thead class="table-light">
                                    <tr><th>When</th><th>Action</th><th>By</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var a in Model.RecentActivity)
                                    {
                                        <tr>
                                            <td>@a.Timestamp.ToLocalTime().ToString("dd MMM yyyy HH:mm")</td>
                                            <td>@a.Action</td>
                                            <td>@(a.PerformedById ?? "System")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            (function () {
                var approved = @Model.AdminApprovedCount;
                var pending = @Model.PendingClaimsCount;
                var rejected = @Model.AdminRejectedCount;

                var ctx = document.getElementById('claimsPieChart').getContext('2d');

                if (window._claimsPieChart instanceof Chart) window._claimsPieChart.destroy();

                window._claimsPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Approved', 'Pending', 'Rejected'],
                        datasets: [{
                            data: [approved || 0, pending || 0, rejected || 0],
                            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            })();
        </script>
    }
}
else
{
    <!-- EMPLOYEE DASHBOARD -->
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">My Claims</h1>
            <div>
                <a class="btn btn-primary" asp-controller="Claims" asp-action="Create">+ New Claim</a>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-sm-6 col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Total</h6>
                        <p class="display-6 mb-0">@Model.MyTotalClaims</p>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Pending</h6>
                        <p class="display-6 mb-0">@Model.MyPendingClaims</p>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Approved</h6>
                        <p class="display-6 mb-0">@Model.MyApprovedClaims</p>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="card text-center shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title">Rejected</h6>
                        <p class="display-6 mb-0">@Model.MyRejectedClaims</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">Recent Claims</div>
            <div class="card-body p-0">
                @if (Model.RecentMyClaims == null || !Model.RecentMyClaims.Any())
                {
                    <div class="p-3 text-muted">You have no recent claims.</div>
                }
                else
                {
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ref</th>
                                <th>Title</th>
                                <th>Claimed</th>
                                <th>Approved</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.RecentMyClaims)
                            {
                                <tr>
                                    <td class="text-break" style="min-width:140px">@c.ClaimRef</td>
                                    <td>@c.Title</td>
                                    <td>₹@c.AmountClaimed.ToString("N2")</td>
                                    <td>@(c.AmountApproved.HasValue ? $"₹{c.AmountApproved.Value.ToString("N2")}" : "—")</td>
                                    <td>
                                        @if (c.Status == ClaimStatus.Pending)
                                        {
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                        else if (c.Status == ClaimStatus.Approved)
                                        {

                                            <span class="badge bg-success">Approved</span>
                                        }
                                        else
                                        {

                                            <span class="badge bg-danger">Rejected</span>
                                        }
                                    </td>
                                    <td>@c.CreatedAt.ToLocalTime().ToString("dd MMM yyyy")</td>
                                    <td><a class="btn btn-sm btn-outline-secondary" asp-controller="Claims" asp-action="Details" asp-route-id="@c.Id">View</a></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
}
